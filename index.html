<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Site Explorer</title>

  <!-- Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>

  <!-- Turf -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Data files -->
  <script src="data/majas_tekdi_2.js"></script>
  <script src="data/plot_1.js"></script>
  <script src="data/buildings_final_5.js"></script>
  <script src="data/road_final_3.js"></script>
  <script src="data/contours_4.js"></script>
  <script src="data/2vp_vegetation_170625vp_vegetation_6.js"></script>
  <script src="data/uhi_zones_k_east_ward_7.js"></script>

  <style>
    :root { --bg:#f6f7fb; --panel:#fff; --text:#1a1c22; --muted:#5a5f6b; --border:#e6e8ef; --accent:#0ea5e9; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font:14px/1.5 'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .app { display:grid; grid-template-columns:360px 1fr; height:100vh; }
    .sidebar { background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column; }
    .sidebar-header { position:sticky; top:0; padding:14px 16px; border-bottom:1px solid var(--border); background:#fff; z-index:2; }
    .site-title { font-weight:600; letter-spacing:.1px; }
    .sections { display:flex; flex-direction:column; gap:8px; padding:12px; overflow:auto; }

    .section-row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .section-row .section-tab { flex:1; text-align:left; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#f8fafc; cursor:pointer; font-weight:500; }
    .section-row .section-tab.active { background:#e8f4ff; border-color:#cfe6ff; }

    .switch { position: relative; display:inline-flex; align-items:center; width:40px; height:22px; }
    .switch input { display:none; }
    .switch span { position:relative; display:block; width:40px; height:22px; background:#e5e7eb; border-radius:999px; box-shadow:inset 0 0 0 1px #d1d5db; transition:background .2s ease; }
    .switch span::after { content:''; position:absolute; top:2px; left:2px; width:18px; height:18px; background:#fff; border-radius:50%; box-shadow:0 1px 2px rgba(0,0,0,.15); transition:transform .2s ease; }
    .switch input:checked + span { background:#0ea5e9; box-shadow:inset 0 0 0 1px #0ea5e9; }
    .switch input:checked + span::after { transform:translateX(18px); }

    .divider { height:1px; background:var(--border); margin:8px 0; }
    .basemap-row { font-size:13px; color:var(--muted); padding:6px 2px; }

    .layer-panel { border-top:1px solid var(--border); padding:12px; overflow:hidden; }
    .panel-head h3 { margin:0 0 6px; font-size:16px; }
    .panel-head p { margin:0; color:var(--muted); }
    .legend-box { margin:10px 0 12px; }
    .ramp { width:160px; height:10px; border-radius:6px; background:linear-gradient(90deg,#fee5d9,#a50f15); border:1px solid var(--border); }
    .ticks { font-size:12px; color:var(--muted); display:flex; justify-content:space-between; width:160px; }
    .sym { display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted); }
    .swatch { width:18px; height:10px; border-radius:2px; border:1px solid var(--border); display:inline-block; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; border:1px solid #064e3b; }
    .line { width:38px; height:2px; display:inline-block; }
    .kpis { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; margin:10px 0 12px; }
    .kpi { border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fafcff; }
    .kpi .k { font-size:12px; color:var(--muted); }
    .kpi .v { font-size:16px; font-weight:600; }

    details.attr { border:1px solid var(--border); border-radius:10px; background:#fff; }
    details.attr > summary { cursor:pointer; padding:8px 10px; font-weight:600; }

    .table-wrap { padding:6px 10px 10px; max-height:42vh; overflow:auto; overscroll-behavior:contain; border-top:1px solid var(--border); }
    .filter { padding:0 10px 8px; position:sticky; top:0; background:#fff; z-index:2; }
    .grid { border-collapse:collapse; width:max-content; min-width:100%; }
    .grid th, .grid td { border:1px solid var(--border); padding:6px 8px; font-size:13px; white-space:nowrap; }
    .grid th { background:#f3f4f6; position:sticky; top:0; z-index:1; }

    .map-wrap { position:relative; }
    #map { position:absolute; inset:0; }
    @media (max-width: 900px) {
      .app { grid-template-columns:1fr; }
      .sidebar { position:absolute; width:92vw; max-width:380px; height:86vh; z-index:20; margin:12px; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,0.15); }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="site-title">Site Explorer</div>
      </div>

      <nav class="sections">
        <div class="section-row" data-layer="uhi">
          <button class="section-tab">Urban heat island</button>
          <label class="switch"><input type="checkbox" class="vis-toggle" data-toggle="uhi" checked /><span></span></label>
        </div>
        <div class="section-row" data-layer="vegetation">
          <button class="section-tab">Vegetation</button>
          <label class="switch"><input type="checkbox" class="vis-toggle" data-toggle="vegetation" checked /><span></span></label>
        </div>
        <div class="section-row" data-layer="buildings">
          <button class="section-tab">Buildings</button>
          <label class="switch"><input type="checkbox" class="vis-toggle" data-toggle="buildings" checked /><span></span></label>
        </div>
        <div class="section-row" data-layer="contours">
          <button class="section-tab">Contours</button>
          <label class="switch"><input type="checkbox" class="vis-toggle" data-toggle="contours" checked /><span></span></label>
        </div>
        <div class="section-row" data-layer="roads">
          <button class="section-tab">Roads</button>
          <label class="switch"><input type="checkbox" class="vis-toggle" data-toggle="roads" checked /><span></span></label>
        </div>
        <div class="section-row" data-layer="site">
          <button class="section-tab">Site</button>
          <label class="switch"><input type="checkbox" class="vis-toggle" data-toggle="site" checked /><span></span></label>
        </div>
        <div class="section-row" data-layer="plot">
          <button class="section-tab">Plot</button>
          <label class="switch"><input type="checkbox" class="vis-toggle" data-toggle="plot" checked /><span></span></label>
        </div>

        <div class="divider"></div>
        <div class="basemap-row">Basemap: Carto Light</div>
      </nav>

      <section class="layer-panel" id="layer-panel"></section>
    </aside>

    <main class="map-wrap">
      <div id="map"></div>
    </main>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoia3Jpc2huYTQ1NjciLCJhIjoiY21kcXNjODg2MDltbTJycTNxMmJsenNhYiJ9.Upxy1ZZPcflUGhWZ004hHw';

    const Store = {
      state:{ activeLayer:'uhi',
        visible:{ uhi:true, vegetation:true, buildings:true, contours:true, roads:true, plot:true, site:true },
        thematic:{ uhi: null }
      },
      subs:new Set(),
      set(p){ Object.assign(this.state,p); this.subs.forEach(fn=>fn(this.state)); },
      on(fn){ this.subs.add(fn); return ()=>this.subs.delete(fn); }
    };
    try { const saved = JSON.parse(localStorage.getItem('layer_visible')||'{}'); Store.state.visible = { ...Store.state.visible, ...saved }; } catch(e){}

    const Layers = {
      uhi:{ title:'Urban heat island', dataVar:'json_uhi_zones_k_east_ward_7', layerIds:['uhi-fill','uhi-line'], definition:'Surface temperature intensity bands relative to local context.', fields:{
        Label:{label:'Label',unit:''},
        UHI_Class:{label:'Class',unit:''},
        first:{label:'First',unit:''}
      } },
      vegetation:{ title:'Vegetation (trees)', dataVar:'json_2vp_vegetation_170625vp_vegetation_6', layerIds:['veg-point'], definition:'Tree locations and attributes.', fields:{
        fid:{label:'Feature id',unit:''}, species:{label:'Species',unit:''}, girth_rad:{label:'Girth radius',unit:'m'}, crown_rad:{label:'Crown radius',unit:'m'}, seas_type:{label:'Seasonality',unit:''}, flaura_typ:{label:'Flora type',unit:''}
      } },
      buildings:{ title:'Buildings', dataVar:'json_buildings_final_5', layerIds:['bldg-fill','bldg-line'], definition:'Building footprints and attributes.', fields:{
        bldg_id:{label:'Building id',unit:''}, bldg_use:{label:'Use',unit:''}, bldg_fp:{label:'Footprint',unit:'m²'}, bldg_area:{label:'Floor area',unit:'m²'}, bldg_ht:{label:'Height',unit:'m'}, bldg_flr:{label:'Floors',unit:''}, no_hh:{label:'Households',unit:''}, pop:{label:'Population',unit:''}, bldg_roof:{label:'Roof',unit:''}
      } },
      contours:{ title:'Contours', dataVar:'json_contours_4', layerIds:['contour-line'], definition:'Elevation contour lines.', fields:{ ID:{label:'Contour id',unit:''}, ELEV:{label:'Elevation',unit:'m'} } },
      roads:{ title:'Roads', dataVar:'json_road_final_3', layerIds:['road-line'], definition:'Road network.', fields:{ ro_name:{label:'Name',unit:''}, ro_width:{label:'Width',unit:'m'}, ro_ml:{label:'Material',unit:''}, ro_typo:{label:'Class',unit:''}, ro_acces:{label:'Access',unit:''} } },
      plot:{ title:'Plot', dataVar:'json_plot_1', layerIds:['plot-fill','plot-line'], definition:'Cadastral plots.', fields:{ survey_no:{label:'Survey no',unit:''}, area:{label:'Area',unit:'m²'}, land_use:{label:'Land use',unit:''}, fsi:{label:'FSI',unit:''} } },
      site:{ title:'Site', dataVar:'json_majas_tekdi_2', layerIds:['site-line'], definition:'Project/site boundary.', fields:{ name:{label:'Name',unit:''}, area:{label:'Area',unit:'m²'}, no_bldg:{label:'Building count',unit:''}, pop:{label:'Population',unit:''}, density:{label:'Density',unit:'per km²'} } }
    };

    function mountSidebar(){
      document.querySelectorAll('.section-row').forEach(row=>{
        const key = row.getAttribute('data-layer');
        const btn = row.querySelector('.section-tab');
        const chk = row.querySelector('.vis-toggle');

        btn.classList.toggle('active', key === Store.state.activeLayer);
        if (chk) chk.checked = Store.state.visible[key] ?? true;

        btn.addEventListener('click', ()=>{
          document.querySelectorAll('.section-tab').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          Store.set({ activeLayer: key });
        });

        if (chk) {
          chk.addEventListener('click', e=> e.stopPropagation());
          chk.addEventListener('change', e=>{
            Store.state.visible[key] = e.target.checked;
            if (window.map) setLayerVisible(key, e.target.checked);
            localStorage.setItem('layer_visible', JSON.stringify(Store.state.visible));
            if (window.map && map.loaded()) applyPreset(Store.state.activeLayer);
          });
        }
      });
    }
    document.addEventListener('DOMContentLoaded', mountSidebar);

    function toArray(fc){ return (fc && fc.features) ? fc.features : []; }
    function legendHTML(key){
      if (key==='uhi') return `<div class="ramp"></div><div class="ticks"><span>Low</span><span>High</span></div>`;
      if (key==='vegetation') return `<div class="sym"><span class="dot" style="background:#16a34a"></span>Trees</div>`;
      if (key==='buildings') return `<div class="sym"><span class="swatch" style="background:#111827"></span>Footprints</div>`;
      if (key==='contours') return `<div class="sym"><span class="line" style="background:#64748b"></span>Contours</div>`;
      if (key==='roads') return `<div class="sym"><span class="line" style="background:#111827"></span>Primary <span class="line" style="background:#4b5563"></span>Secondary</div>`;
      if (key==='site') return `<div class="sym"><span class="line" style="background:#0ea5e9"></span>Boundary</div>`;
      if (key==='plot') return `<div class="sym"><span class="swatch" style="background:#38bdf8"></span>Plot area</div>`;
      return '';
    }

    // UHI theming helpers
    function collectValues(fc, prop){
      const a=[]; if (!fc?.features) return a;
      fc.features.forEach(f=>{
        const v=f.properties?.[prop];
        if (v!==null && v!==undefined && v!=='' && !Number.isNaN(v)) a.push(v);
      });
      return a;
    }
    function quantileBreaks(arr, k=5){
      if (!arr.length) return [];
      const a=[...arr].map(Number).filter(v=>!isNaN(v)).sort((x,y)=>x-y);
      const br=[]; for (let i=1;i<k;i++){ const q=i/k; const idx=Math.floor(q*(a.length-1)); br.push(a[idx]); }
      br.push(a[a.length-1]); return br;
    }
    const PALETTE_CONT = ['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#084594'];
    const PALETTE_CAT  = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22'];

    function fillPaintNumeric(field, breaks){
      const stops=[]; stops.push(breaks[0], PALETTE_CONT[1]);
      for (let i=1;i<breaks.length;i++){
        stops.push(breaks[i], PALETTE_CONT[Math.min(i+1, PALETTE_CONT.length-1)]);
      }
      return ['step', ['to-number',['get', field]], PALETTE_CONT[0], ...stops];
    }
    function fillPaintCategorical(field, cats){
      const expr=['match', ['get', field]];
      cats.forEach((c,i)=>{ expr.push(c, PALETTE_CAT[i % PALETTE_CAT.length]); });
      expr.push('Other', '#cccccc'); return expr;
    }

    function defaultUhiPaint(){
      return {
        fill: {
          'fill-color': [
            'match', ['get','Label'],
            'Extreme (>5°C)', '#de2d26',
            'Very High (4–5°C)', '#fb6a4a',
            'High (3–4°C)', '#fcae91',
            'Moderate (2–3°C)', '#fee5d9',
            'Low (1–2°C)', '#fef0d9',
            'Very Low (<1°C)', '#fff5eb',
            '#fb6a4a'
          ],
          'fill-opacity': 0.45
        },
        line: { 'line-color':'#ff7f50','line-width':1,'line-opacity':0.8 }
      };
    }

    function renderLayerSection(state){
      const v=Layers[state.activeLayer];
      const root=document.getElementById('layer-panel');
      root.innerHTML = `
        <div class="panel-head"><h3>${v.title}</h3><p class="muted">${v.definition}</p></div>
        <div class="legend-box">${legendHTML(state.activeLayer)}</div>
        ${state.activeLayer==='uhi' ? `
          <details open class="attr">
            <summary>Fields</summary>
            <div id="uhi-fields" style="padding:8px 10px; display:grid; gap:6px;"></div>
          </details>` : ``}
        <div class="kpis" id="kpis">Loading metrics…</div>
        <details open class="attr">
          <summary>Attributes</summary>
          <div id="schema"></div>
          <div class="table-wrap"><div id="table-host"></div></div>
        </details>`;

      if (state.activeLayer==='uhi') renderUhiFieldsList();
      document.getElementById('schema').innerHTML = renderSchema(state.activeLayer);
      updateAttrTable(state.activeLayer);
    }
    Store.on(renderLayerSection);

    function renderUhiFieldsList(){
      const host = document.getElementById('uhi-fields'); if (!host) return;
      const fields = Layers.uhi.fields;
      const keys = Object.keys(fields);
      const active = Store.state.thematic.uhi;

      let html = `<button data-uhi-field="" style="text-align:left;padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;">None (default)</button>`;
      keys.forEach(k=>{
        const is = active===k;
        html += `<button data-uhi-field="${k}" style="text-align:left;padding:6px 8px;border:1px solid ${is?'#93c5fd':'var(--border)'};border-radius:8px;background:${is?'#eff6ff':'#fff'};cursor:pointer;">${fields[k].label||k}</button>`;
      });
      host.innerHTML = html;

      host.querySelectorAll('button[data-uhi-field]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const fld = btn.getAttribute('data-uhi-field') || null;
          Store.state.thematic.uhi = fld;
          applyUhiThematic();
          renderUhiFieldsList();
        });
      });
    }

    function renderSchema(layerKey){
      const { dataVar, fields } = Layers[layerKey];
      const props = toArray(window[dataVar])[0]?.properties || {};
      return `<div class="schema">${Object.keys(fields).map(k=>{
        const def=fields[k]; const sample=props[k]??'—';
        return `<div class="field"><span class="k">${k}</span><span class="lab">${def.label}</span><span class="ex">${String(sample)}</span><span class="u">${def.unit}</span></div>`;
      }).join('')}</div>`;
    }
    function renderTable(layerKey, filter=''){
      const { dataVar, fields } = Layers[layerKey];
      const feats = toArray(window[dataVar]);
      const cols = Object.keys(fields);
      const f = filter.toLowerCase();
      const rows = feats.filter(ft=> f ? cols.some(c=> String(ft.properties[c]??'').toLowerCase().includes(f)) : true)
        .map(ft=> `<tr>${cols.map(c=>`<td>${ft.properties[c]??''}</td>`).join('')}</tr>`).join('');
      return `<table class="grid"><thead><tr>${cols.map(c=>`<th>${fields[c].label||c}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table>`;
    }
    function updateAttrTable(layerKey){
      const host=document.getElementById('table-host');
      host.innerHTML = `<div class="filter"><input id="attr-filter" placeholder="Filter attributes..." /></div>` + renderTable(layerKey);
      host.querySelector('#attr-filter').addEventListener('input', (e)=>{
        const tables=host.querySelectorAll('table'); tables.forEach(t=>t.remove());
        host.insertAdjacentHTML('beforeend', renderTable(layerKey, e.target.value));
      });
    }
    function fmt(n,d=0){ return (n==null || isNaN(n)) ? '—' : Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }
    function computeKPIs(layerKey){
      const L = Layers[layerKey]; const feats = toArray(window[L.dataVar]);
      if (layerKey==='vegetation') return [{label:'Tree points',value:fmt(feats.length)},{label:'Species filled',value:fmt(feats.filter(f=>f.properties.species).length)}];
      if (layerKey==='buildings'){ const cnt=feats.length; const fp=feats.reduce((s,f)=>s+(+f.properties.bldg_fp||0),0); const siteArea=window.json_majas_tekdi_2?.features?.[0]?.properties?.area||null; const cov=siteArea?(fp/siteArea*100):null; return [{label:'Buildings',value:fmt(cnt)},{label:'Footprint',value:fmt(fp,1)+' m²'},{label:'Coverage',value:cov==null?'—':fmt(cov,1)+'%'}];}
      if (layerKey==='roads'){ return [{label:'Road segments',value:fmt(feats.length)},{label:'Classes',value:fmt(new Set(feats.map(f=>f.properties.ro_typo)).size)}];}
      if (layerKey==='contours'){ const v=feats.map(f=>+f.properties.ELEV).filter(x=>!isNaN(x)); return [{label:'Contours',value:fmt(v.length)},{label:'Elevation range',value:v.length?`${fmt(Math.min(...v))}–${fmt(Math.max(...v))} m`:'—'}];}
      if (layerKey==='uhi'){ const bands={}; feats.forEach(f=>{ const b=f.properties.Label ?? f.properties.UHI_Class ?? 'n/a'; bands[b]=(bands[b]||0)+1;}); const items=Object.entries(bands).slice(0,3).map(([k,v])=>`${k}:${v}`).join('  '); return [{label:'UHI polygons',value:fmt(feats.length)},{label:'Top labels/classes',value:items||'—'}];}
      if (layerKey==='plot'){ const cnt=feats.length; const area=feats.reduce((s,f)=>s+(+f.properties.area||0),0); return [{label:'Parcels',value:fmt(cnt)},{label:'Total area',value:fmt(area,1)+' m²'}];}
      if (layerKey==='site'){ const p=window.json_majas_tekdi_2?.features?.[0]?.properties||{}; return [{label:'Site area',value:p.area?fmt(p.area,1)+' m²':'—'},{label:'Buildings',value:fmt(p.no_bldg)},{label:'Population',value:fmt(p.pop)}];}
      return [];
    }
    Store.on(state=>{
      const el=document.getElementById('kpis');
      if (el) el.innerHTML = computeKPIs(state.activeLayer).map(i=>`<div class="kpi"><div class="k">${i.label}</div><div class="v">${i.value}</div></div>`).join('') || '<div class="muted">No KPIs available</div>';
    });

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [72.859, 19.141],
      zoom: 15,
      attributionControl: true,
      hash: true
    });
    window.map = map;
    map.addControl(new mapboxgl.NavigationControl({visualizePitch:true}),'top-right');
    map.addControl(new mapboxgl.ScaleControl({maxWidth:140, unit:'metric'}));
    map.scrollZoom.setWheelZoomRate(1/600);
    map.scrollZoom.setZoomRate(1/1.6);

    // Smooth 700 m focus
    const RADIUS_METERS = 700;
    const SPAN_METERS   = 700;

    function zoomForMetersAtLat(targetMeters, lat, pxWidth) {
      const metersPerPixelAtZ0 = 156543.03392 * Math.cos(lat * Math.PI / 180);
      return Math.log2((metersPerPixelAtZ0 * pxWidth) / targetMeters);
    }
    function buildingsBBox() {
      const fc = window.json_buildings_final_5;
      return (fc && fc.features && fc.features.length) ? turf.bbox(fc) : null;
    }
    function buildingsCentroid() {
      const b = buildingsBBox(); return b ? [(b[0]+b[2])/2, (b[1]+b[3])/2] : null;
    }
    let buildingsCenter = null;

    function applyZoomOutCapSpan() {
      const b = buildingsBBox(); if (!b) return;
      const lat = (b[1]+b[3])/2, px = map.getCanvas().width || 800;
      const zMin = zoomForMetersAtLat(SPAN_METERS, lat, px);
      const clamp = Math.min(zMin, map.getMaxZoom() ?? 24);
      map.setMinZoom(clamp);
      if (map.getZoom() < clamp) map.easeTo({ zoom: clamp, duration: 120 });
    }

    let panGuardTimer = null;
    function scheduleRadiusGuard() {
      if (panGuardTimer) clearTimeout(panGuardTimer);
      panGuardTimer = setTimeout(enforceRadiusEased, 150);
    }
    function enforceRadiusEased() {
      if (!buildingsCenter) return;
      const c = map.getCenter();
      const d = turf.distance(turf.point([c.lng, c.lat]), turf.point(buildingsCenter), { units:'meters' });
      if (d > RADIUS_METERS) {
        map.easeTo({ center: buildingsCenter, duration: 250, easing: t => t });
      }
    }

    function ensureSource(id, dataVarName){
      const data=window[dataVarName]; if (!data){ console.warn('Missing data var:', dataVarName); return false; }
      if (!map.getSource(id)) map.addSource(id, {type:'geojson', data}); return true;
    }
    function addLayers(){
      if (ensureSource('site','json_majas_tekdi_2')) map.addLayer({id:'site-line', type:'line', source:'site', paint:{'line-color':'#0ea5e9','line-width':2.5}});
      if (ensureSource('plot','json_plot_1')) {
        map.addLayer({id:'plot-fill', type:'fill', source:'plot', paint:{'fill-color':'#38bdf8','fill-opacity':0.25}});
        map.addLayer({id:'plot-line', type:'line', source:'plot', paint:{'line-color':'#38bdf8','line-width':2}});
      }
      if (ensureSource('bldg','json_buildings_final_5')) {
        map.addLayer({id:'bldg-fill', type:'fill', source:'bldg', paint:{'fill-color':'#111827','fill-opacity':0.8}});
        map.addLayer({id:'bldg-line', type:'line', source:'bldg', paint:{'line-color':'#ffffff','line-width':0.2,'line-opacity':0.5}});
      }
      if (ensureSource('uhi','json_uhi_zones_k_east_ward_7')) {
        const p = defaultUhiPaint();
        map.addLayer({id:'uhi-fill', type:'fill', source:'uhi', paint: p.fill});
        map.addLayer({id:'uhi-line', type:'line', source:'uhi', paint: p.line});
      }
      if (ensureSource('veg','json_2vp_vegetation_170625vp_vegetation_6')) map.addLayer({id:'veg-point', type:'circle', source:'veg', paint:{'circle-radius':4,'circle-color':'#16a34a','circle-stroke-width':1,'circle-stroke-color':'#064e3b'}});
      if (ensureSource('roads','json_road_final_3')) map.addLayer({id:'road-line', type:'line', source:'roads', paint:{'line-color':'#0f172a','line-width':2,'line-opacity':0.85}});
      if (ensureSource('contours','json_contours_4')) map.addLayer({id:'contour-line', type:'line', source:'contours', paint:{'line-color':'#64748b','line-width':1.2,'line-opacity':0.7}});
    }

    function setLayerVisible(key, on){
      (Layers[key].layerIds||[]).forEach(id=>{
        if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', on ? 'visible' : 'none');
      });
    }

    const presets = {
      uhi:{ show:['uhi-fill','uhi-line'], dim:['bldg-fill','bldg-line'], extras:['road-line','contour-line','site-line','plot-fill','plot-line','veg-point'] },
      vegetation:{ show:['veg-point'], dim:['bldg-fill','bldg-line'], extras:['road-line','contour-line','site-line','plot-fill','plot-line','uhi-fill','uhi-line'] },
      buildings:{ show:['bldg-fill','bldg-line'], dim:[], extras:['road-line','contour-line','site-line','plot-fill','plot-line','uhi-fill','uhi-line','veg-point'] },
      contours:{ show:['contour-line'], dim:['bldg-fill','bldg-line'], extras:['road-line','site-line','plot-fill','plot-line','uhi-fill','uhi-line','veg-point'] },
      roads:{ show:['road-line'], dim:['bldg-fill','bldg-line'], extras:['contour-line','site-line','plot-fill','plot-line','uhi-fill','uhi-line','veg-point'] },
      site:{ show:['site-line'], dim:['bldg-fill','bldg-line'], extras:['road-line','contour-line','uhi-fill','uhi-line','veg-point','plot-fill','plot-line'] },
      plot:{ show:['plot-fill','plot-line'], dim:['bldg-fill','bldg-line'], extras:['road-line','contour-line','uhi-fill','uhi-line','veg-point','site-line'] }
    };

    function applyPreset(key){
      const all=new Set([].concat(...Object.values(presets).map(v=>[...v.show,...v.dim,...v.extras])));
      all.forEach(id=>{ if(map.getLayer(id)) map.setLayoutProperty(id,'visibility','none'); });

      const ok = (layerKey) => Store.state.visible[layerKey] !== false;
      const mapIdToKey = {
        'uhi-fill':'uhi','uhi-line':'uhi',
        'veg-point':'vegetation',
        'bldg-fill':'buildings','bldg-line':'buildings',
        'contour-line':'contours',
        'road-line':'roads',
        'plot-fill':'plot','plot-line':'plot',
        'site-line':'site'
      };

      const ids = [...(presets[key]?.show||[]), ...(presets[key]?.dim||[]), ...(presets[key]?.extras||[])];
      ids.forEach(id=>{
        const k = mapIdToKey[id]; if (!k || !ok(k)) return;
        if (map.getLayer(id)) map.setLayoutProperty(id,'visibility','visible');
      });

      if (Store.state.visible.buildings && (presets[key]?.dim||[]).includes('bldg-fill') && map.getLayer('bldg-fill')) {
        map.setPaintProperty('bldg-fill','fill-color','#111827');
        map.setPaintProperty('bldg-fill','fill-opacity',0.35);
      }
    }

    function attachFeatureInfo(){
      Object.keys(Layers).forEach(key=>{
        Layers[key].layerIds.forEach(id=>{
          if(!map.getLayer(id)) return;
          map.on('click', id, (e)=>{
            const f=e.features?.[0]; if(!f) return;
            const fields=Layers[key].fields;
            const rows=Object.keys(fields).map(k=> `<div><span class="lab">${fields[k].label||k}:</span> ${f.properties[k]??'—'}</div>`).join('');
            new mapboxgl.Popup({closeButton:true,closeOnClick:true}).setLngLat(e.lngLat).setHTML(`<div class="tip"><div class="tip-title">${Layers[key].title}</div>${rows}</div>`).addTo(map);
          });
          map.on('mouseenter', id, ()=> map.getCanvas().style.cursor='pointer');
          map.on('mouseleave', id, ()=> map.getCanvas().style.cursor='');
        });
      });
    }

    function applyUhiThematic(){
      if (!map.getLayer('uhi-fill')) return;
      const field = Store.state.thematic.uhi;
      if (!field){
        const p=defaultUhiPaint();
        map.setPaintProperty('uhi-fill','fill-color', p.fill['fill-color']);
        map.setPaintProperty('uhi-fill','fill-opacity', p.fill['fill-opacity']);
        return;
      }
      const fc = window.json_uhi_zones_k_east_ward_7;
      const values = collectValues(fc, field);
      const numeric = values.every(v=> !isNaN(Number(v)));
      if (numeric){
        const br = quantileBreaks(values.map(Number), 5);
        const expr = fillPaintNumeric(field, br);
        map.setPaintProperty('uhi-fill','fill-color', expr);
        map.setPaintProperty('uhi-fill','fill-opacity', 0.6);
      } else {
        const freq = new Map();
        values.forEach(v=> freq.set(v, (freq.get(v)||0)+1));
        const cats = [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,9).map(d=>d[0]);
        const expr = fillPaintCategorical(field, cats);
        map.setPaintProperty('uhi-fill','fill-color', expr);
        map.setPaintProperty('uhi-fill','fill-opacity', 0.6);
      }
    }

    function initSmoothFocus(){
      try{
        let box=null;
        if (window.json_majas_tekdi_2?.features?.length) box=turf.bbox(window.json_majas_tekdi_2);
        else if (window.json_buildings_final_5?.features?.length) box=turf.bbox(window.json_buildings_final_5);
        else if (window.json_plot_1?.features?.length) box=turf.bbox(window.json_plot_1);
        if (box) map.fitBounds([[box[0],box[1]],[box[2],box[3]]], { padding: 40, duration: 0 });
      }catch(e){ console.warn('fitBounds error', e); }

      buildingsCenter = buildingsCentroid();
      applyZoomOutCapSpan();
      enforceRadiusEased();

      window.addEventListener('resize', applyZoomOutCapSpan);
      map.on('zoom', applyZoomOutCapSpan);
      map.on('move', scheduleRadiusGuard);
      map.on('moveend', enforceRadiusEased);
    }

    map.on('load', ()=>{
      addLayers();
      Object.keys(Layers).forEach(k => setLayerVisible(k, Store.state.visible[k] !== false));

      attachFeatureInfo();
      renderLayerSection(Store.state);
      const el=document.getElementById('kpis');
      if (el) el.innerHTML = computeKPIs(Store.state.activeLayer).map(i=>`<div class="kpi"><div class="k">${i.label}</div><div class="v">${i.value}</div></div>`).join('');

      setTimeout(()=>{
        applyPreset(Store.state.activeLayer);
        initSmoothFocus();
        applyUhiThematic();
      }, 60);
    });

    Store.on(s=>{
      if(map.loaded()) {
        applyPreset(s.activeLayer);
        if (s.activeLayer==='uhi') applyUhiThematic();
      }
    });
  </script>
</body>
</html>
