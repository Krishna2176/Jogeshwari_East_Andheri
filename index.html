<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Site Explorer</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>

  <!-- Turf (optional but useful for fitBounds/KPI clipping) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Data: include provided shapefile-converted JS files before app code -->
  <script src="majas_tekdi_2.js"></script>
  <script src="plot_1.js"></script>
  <script src="buildings_final_5.js"></script>
  <script src="road_final_3.js"></script>
  <script src="contours_4.js"></script>
  <script src="2vp_vegetation_170625vp_vegetation_6.js"></script>
  <script src="uhi_zones_k_east_ward_7.js"></script>

  <style>
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --text: #1a1c22;
      --muted: #5a5f6b;
      --border: #e6e8ef;
      --accent: #0ea5e9;
      --accent-2: #38bdf8;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .app { display: grid; grid-template-columns: 360px 1fr; height: 100vh; }
    .sidebar { background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; min-width: 300px; }
    .sidebar-header { position: sticky; top: 0; background: var(--panel); padding: 14px 16px; border-bottom: 1px solid var(--border); z-index: 2; }
    .site-title { font-weight: 600; }
    .extent { margin-top: 8px; color: var(--muted); display: flex; gap: 12px; }
    .sections { display: flex; flex-direction: column; gap: 6px; padding: 12px; overflow: auto; }
    .section-tab { text-align: left; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #f8fafc; cursor: pointer; }
    .section-tab.active { background: #e8f4ff; border-color: #cfe6ff; }
    .divider { height: 1px; background: var(--border); margin: 8px 0; }
    .basemap-row { font-size: 13px; color: var(--muted); padding: 6px 12px; }
    .layer-panel { border-top: 1px solid var(--border); padding: 12px; overflow: auto; }
    .panel-head h3 { margin: 0 0 6px 0; font-size: 16px; }
    .panel-head p { margin: 0; color: var(--muted); }
    .legend-box { margin: 10px 0 12px; }
    .ramp { width: 160px; height: 10px; border-radius: 6px; background: linear-gradient(90deg, var(--from, #fee5d9), var(--to, #a50f15)); border: 1px solid var(--border); }
    .ticks { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; width: 160px; }
    .sym { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); }
    .swatch { width: 18px; height: 10px; border-radius: 2px; border: 1px solid var(--border); display: inline-block; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; border: 1px solid #064e3b; }
    .line { width: 38px; height: 2px; display: inline-block; }
    .kpis { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; margin: 10px 0 12px; }
    .kpi { border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; background: #fafcff; }
    .kpi .k { font-size: 12px; color: var(--muted); }
    .kpi .v { font-size: 16px; font-weight: 600; }
    details.attr { border: 1px solid var(--border); border-radius: 10px; background: #fff; }
    details.attr > summary { cursor: pointer; padding: 8px 10px; font-weight: 600; }
    .schema { padding: 8px 10px; display: grid; gap: 6px; }
    .schema .field { display: grid; grid-template-columns: 140px 1fr 1fr 60px; gap: 6px; font-size: 13px; }
    .schema .k { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: #334155; }
    .schema .lab { color: var(--muted); }
    .schema .ex { color: #111827; }
    .schema .u { color: var(--muted); text-align: right; }
    .table-wrap { padding: 6px 10px 10px; overflow: auto; }
    .filter { padding: 0 10px 8px; }
    .grid { border-collapse: collapse; width: 100%; }
    .grid th, .grid td { border: 1px solid var(--border); padding: 6px 8px; font-size: 13px; }
    .grid th { background: #f3f4f6; text-align: left; }
    .map-wrap { position: relative; }
    #map { position: absolute; inset: 0; }
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { position: absolute; width: 92vw; max-width: 380px; height: 86vh; z-index: 20; margin: 12px; border-radius: 12px; box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
    }
    :focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 6px; }
    @media (prefers-reduced-motion) { * { transition: none !important; animation: none !important; } }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="site-title">Site Explorer</div>
        <div class="extent">
          <label><input type="radio" name="extent" value="site" checked> Site</label>
          <label><input type="radio" name="extent" value="viewport"> Viewport</label>
        </div>
      </div>

      <nav class="sections">
        <button class="section-tab" data-layer="uhi">Urban heat island</button>
        <button class="section-tab" data-layer="vegetation">Vegetation</button>
        <button class="section-tab" data-layer="buildings">Buildings</button>
        <button class="section-tab" data-layer="contours">Contours</button>
        <button class="section-tab" data-layer="roads">Roads</button>
        <button class="section-tab" data-layer="site">Site & plot</button>
        <div class="divider"></div>
        <div class="basemap-row">Basemap: Carto Light</div>
      </nav>

      <section class="layer-panel" id="layer-panel">
        <!-- Layer content renders here -->
      </section>
    </aside>

    <main class="map-wrap">
      <div id="map"></div>
    </main>
  </div>

  <script>
    // Store (minimal unidirectional state)
    const Store = {
      state: { activeLayer: 'uhi', extent: 'site' },
      subs: new Set(),
      set(patch) { Object.assign(this.state, patch); this.subs.forEach(fn=>fn(this.state)); },
      on(fn) { this.subs.add(fn); return ()=>this.subs.delete(fn); }
    };

    // Layer registry mapped to provided data variables
    const Layers = {
      uhi: {
        title: 'Urban heat island',
        dataVar: 'json_uhi_zones_k_east_ward_7',
        geom: 'polygon',
        layerIds: ['uhi-fill','uhi-line'],
        definition: 'Surface temperature intensity bands relative to local context within the site.',
        fields: {
          // adjust to match actual uhi properties in your dataset
          value: { label: 'UHI value', unit: '°C' },
          band: { label: 'Intensity band', unit: '' }
        }
      },
      vegetation: {
        title: 'Vegetation (trees)',
        dataVar: 'json_2vp_vegetation_170625vp_vegetation_6',
        geom: 'point',
        layerIds: ['veg-point'],
        definition: 'Tree locations and attributes; use for canopy context and counts within the site.',
        fields: {
          fid: { label: 'Feature id', unit: '' },
          species: { label: 'Species', unit: '' },
          girth_rad: { label: 'Girth radius', unit: 'm' },
          crown_rad: { label: 'Crown radius', unit: 'm' },
          seas_type: { label: 'Seasonality', unit: '' },
          flaura_typ: { label: 'Flora type', unit: '' }
        }
      },
      buildings: {
        title: 'Buildings',
        dataVar: 'json_buildings_final_5',
        geom: 'polygon',
        layerIds: ['bldg-fill','bldg-line'],
        definition: 'Building footprints and attributes used for figure–ground and coverage summaries.',
        fields: {
          bldg_id: { label: 'Building id', unit: '' },
          bldg_use: { label: 'Use', unit: '' },
          bldg_fp: { label: 'Footprint', unit: 'm²' },
          bldg_area: { label: 'Floor area', unit: 'm²' },
          bldg_ht: { label: 'Height', unit: 'm' },
          bldg_flr: { label: 'Floors', unit: '' },
          no_hh: { label: 'Households', unit: '' },
          pop: { label: 'Population', unit: '' },
          bldg_roof: { label: 'Roof', unit: '' }
        }
      },
      contours: {
        title: 'Contours',
        dataVar: 'json_contours_4',
        geom: 'line',
        layerIds: ['contour-line'],
        definition: 'Elevation contour lines providing site topography context.',
        fields: {
          ID: { label: 'Contour id', unit: '' },
          ELEV: { label: 'Elevation', unit: 'm' }
        }
      },
      roads: {
        title: 'Roads',
        dataVar: 'json_road_final_3',
        geom: 'line',
        layerIds: ['road-line'],
        definition: 'Road network with width, material, type, and access class.',
        fields: {
          ro_name: { label: 'Name', unit: '' },
          ro_width: { label: 'Width', unit: 'm' },
          ro_ml: { label: 'Material', unit: '' },
          ro_typo: { label: 'Class', unit: '' },
          ro_acces: { label: 'Access', unit: '' }
        }
      },
      plot: {
        title: 'Plot area',
        dataVar: 'json_plot_1',
        geom: 'polygon',
        layerIds: ['plot-fill','plot-line'],
        definition: 'Cadastral plots with survey numbers and area; also defines analysis extent if chosen.',
        fields: {
          survey_no: { label: 'Survey no', unit: '' },
          area: { label: 'Area', unit: 'm²' },
          land_use: { label: 'Land use', unit: '' },
          fsi: { label: 'FSI', unit: '' }
        }
      },
      site: {
        title: 'Site boundary',
        dataVar: 'json_majas_tekdi_2',
        geom: 'polygon',
        layerIds: ['site-line'],
        definition: 'Project/site boundary and metadata; default extent for KPIs on a small canvas.',
        fields: {
          name: { label: 'Name', unit: '' },
          area: { label: 'Area', unit: 'm²' },
          no_bldg: { label: 'Building count', unit: '' },
          pop: { label: 'Population', unit: '' },
          density: { label: 'Density', unit: 'per km²' }
        }
      }
    };

    // UI wiring: tabs and extent radios
    function mountSidebar() {
      const tabs = document.querySelectorAll('.section-tab');
      tabs.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          tabs.forEach(b=>b.classList.toggle('active', b===btn));
          Store.set({ activeLayer: btn.dataset.layer });
        });
      });
      document.querySelector('.section-tab[data-layer="'+Store.state.activeLayer+'"]').classList.add('active');
      document.querySelectorAll('input[name="extent"]').forEach(r=>{
        r.addEventListener('change', e=>Store.set({ extent: e.target.value }));
      });
    }

    function toArray(fc) { return (fc && fc.features) ? fc.features : []; }

    function legendHTML(key) {
      if (key==='uhi') return `<div class="ramp" style="--from:#fee5d9;--to:#a50f15"></div><div class="ticks"><span>Low</span><span>High</span></div>`;
      if (key==='vegetation') return `<div class="sym"><span class="dot" style="background:#16a34a"></span>Trees</div>`;
      if (key==='buildings') return `<div class="sym"><span class="swatch" style="background:#111827"></span>Footprints</div>`;
      if (key==='contours') return `<div class="sym"><span class="line" style="background:#64748b"></span>Contours</div>`;
      if (key==='roads') return `<div class="sym"><span class="line" style="background:#111827"></span>Primary <span class="line" style="background:#4b5563"></span>Secondary</div>`;
      if (key==='site' || key==='plot') return `<div class="sym"><span class="line" style="background:#0ea5e9"></span>Boundary</div>`;
      return '';
    }

    function renderLayerSection(state) {
      const defs = Object.fromEntries(Object.entries(Layers).map(([k,v])=>[k,{title:v.title, desc:v.definition}]));
      const d = defs[state.activeLayer];
      const root = document.getElementById('layer-panel');
      root.innerHTML = `
        <div class="panel-head">
          <h3>${d.title}</h3>
          <p class="muted">${d.desc}</p>
        </div>
        <div class="legend-box">${legendHTML(state.activeLayer)}</div>
        <div class="kpis" id="kpis">Loading metrics…</div>
        <details open class="attr">
          <summary>Attributes</summary>
          <div id="schema">Loading fields…</div>
          <div class="table-wrap"><div id="table-host"></div></div>
        </details>
      `;
    }
    Store.on(renderLayerSection);

    function renderSchema(layerKey) {
      const { dataVar, fields } = Layers[layerKey];
      const fc = window[dataVar];
      const props = toArray(fc)[0]?.properties || {};
      const rows = Object.keys(fields).map(k=>{
        const def = fields[k];
        const sample = props[k] ?? '—';
        return `<div class="field"><span class="k">${k}</span><span class="lab">${def.label}</span><span class="ex">${String(sample)}</span><span class="u">${def.unit}</span></div>`;
      }).join('');
      return `<div class="schema">${rows}</div>`;
    }

    function renderAttrTable(layerKey, filterText='') {
      const { dataVar, fields } = Layers[layerKey];
      const fc = window[dataVar]; const feats = toArray(fc);
      const cols = Object.keys(fields);
      const head = `<table class="grid"><thead><tr>${cols.map(c=>`<th>${fields[c].label||c}</th>`).join('')}</tr></thead><tbody>`;
      const f = filterText.trim().toLowerCase();
      const bodyRows = feats.filter(ft=>{
        if (!f) return true;
        return cols.some(c => String(ft.properties[c] ?? '').toLowerCase().includes(f));
      }).map(ft=>{
        return `<tr>${cols.map(c=>`<td>${ft.properties[c] ?? ''}</td>`).join('')}</tr>`;
      }).join('');
      return `${head}${bodyRows}</tbody></table>`;
    }

    function updateAttributesPanel(state) {
      const schemaEl = document.getElementById('schema');
      if (schemaEl) schemaEl.innerHTML = renderSchema(state.activeLayer);
      const host = document.getElementById('table-host');
      if (host) {
        host.innerHTML = `<div class="filter"><input id="attr-filter" placeholder="Filter attributes..." /></div>` + renderAttrTable(state.activeLayer);
        const input = host.querySelector('#attr-filter');
        input.addEventListener('input', (e)=>{
          // re-render table part only
          const tables = host.querySelectorAll('table');
          tables.forEach(t=>t.remove());
          host.insertAdjacentHTML('beforeend', renderAttrTable(state.activeLayer, e.target.value));
        });
      }
    }
    Store.on(updateAttributesPanel);

    function fmt(n, d=0) { return (n==null || isNaN(n)) ? '—' : Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }

    function computeKPIs(layerKey) {
      const L = Layers[layerKey];
      const feats = toArray(window[L.dataVar]);
      if (layerKey==='vegetation') {
        return [
          { label:'Tree points', value: fmt(feats.length) },
          { label:'Species filled', value: fmt(feats.filter(f=>f.properties.species).length) }
        ];
      }
      if (layerKey==='buildings') {
        const cnt = feats.length;
        const fp = feats.reduce((s,f)=> s + (Number(f.properties.bldg_fp)||0), 0);
        const siteArea = window[Layers.site.dataVar]?.features?.[0]?.properties?.area || null;
        const cov = siteArea ? (fp/siteArea*100) : null;
        return [
          { label:'Buildings', value: fmt(cnt) },
          { label:'Footprint', value: fmt(fp,1)+' m²' },
          { label:'Coverage', value: cov==null?'—':fmt(cov,1)+'%' }
        ];
      }
      if (layerKey==='roads') {
        return [
          { label:'Road segments', value: fmt(feats.length) },
          { label:'Classes', value: fmt(new Set(feats.map(f=>f.properties.ro_typo)).size) }
        ];
      }
      if (layerKey==='contours') {
        const vals = feats.map(f=>Number(f.properties.ELEV)).filter(v=>!isNaN(v));
        return [
          { label:'Contours', value: fmt(vals.length) },
          { label:'Elevation range', value: vals.length? `${fmt(Math.min(...vals))}–${fmt(Math.max(...vals))} m` : '—' }
        ];
      }
      if (layerKey==='uhi') {
        const bands = {};
        feats.forEach(f=>{
          const b = f.properties.band ?? f.properties.class ?? 'n/a';
          bands[b] = (bands[b]||0)+1;
        });
        const items = Object.entries(bands).slice(0,3).map(([k,v])=>`${k}:${v}`).join('  ');
        return [
          { label:'UHI polygons', value: fmt(feats.length) },
          { label:'Top bands', value: items || '—' }
        ];
      }
      if (layerKey==='plot') {
        const cnt = feats.length;
        const area = feats.reduce((s,f)=> s + (Number(f.properties.area)||0), 0);
        return [
          { label:'Parcels', value: fmt(cnt) },
          { label:'Total area', value: fmt(area,1)+' m²' }
        ];
      }
      if (layerKey==='site') {
        const site = window[Layers.site.dataVar]?.features?.[0]?.properties || {};
        return [
          { label:'Site area', value: site.area? fmt(site.area,1)+' m²':'—' },
          { label:'Buildings', value: fmt(site.no_bldg) },
          { label:'Population', value: fmt(site.pop) }
        ];
      }
      return [];
    }

    function renderKPIs(state) {
      const items = computeKPIs(state.activeLayer);
      const html = items.map(i=>`<div class="kpi"><div class="k">${i.label}</div><div class="v">${i.value}</div></div>`).join('');
      const el = document.getElementById('kpis');
      if (el) el.innerHTML = html || '<div class="muted">No KPIs available</div>';
    }
    Store.on(renderKPIs);

    // Map init
    mapboxgl.accessToken = 'pk.eyJ1Ijoia3Jpc2huYTQ1NjciLCJhIjoiY21kcXNjODg2MDltbTJycTNxMmJsenNhYiJ9.Upxy1ZZPcflUGhWZ004hHw';

    const map = new mapboxgl.Map({
      container: 'map',
      // If Carto Light style id is not available, fallback to Mapbox Light
      style: 'mapbox://styles/mapbox/light-v11',
      center: [72.8589, 19.1409],
      zoom: 16.5,
      attributionControl: true,
      hash: true
    });
    window.map = map;

    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');
    map.addControl(new mapboxgl.ScaleControl({ maxWidth: 140, unit: 'metric' }));

    function addGeoJSONSource(map, id, dataVarName) {
      const data = window[dataVarName];
      if (!data) return;
      if (map.getSource(id)) return;
      map.addSource(id, { type: 'geojson', data });
    }

    function addLayers(map) {
      // Site
      addGeoJSONSource(map, 'site', Layers.site.dataVar);
      if (!map.getLayer('site-line')) map.addLayer({ id:'site-line', type:'line', source:'site',
        paint:{ 'line-color':'#0ea5e9', 'line-width':2.5 } });

      // Plot
      addGeoJSONSource(map, 'plot', Layers.plot.dataVar);
      if (!map.getLayer('plot-fill')) map.addLayer({ id:'plot-fill', type:'fill', source:'plot',
        paint:{ 'fill-color':'#38bdf8', 'fill-opacity':0.12 } });
      if (!map.getLayer('plot-line')) map.addLayer({ id:'plot-line', type:'line', source:'plot',
        paint:{ 'line-color':'#38bdf8', 'line-width':1.5 } });

      // Buildings
      addGeoJSONSource(map, 'bldg', Layers.buildings.dataVar);
      if (!map.getLayer('bldg-fill')) map.addLayer({ id:'bldg-fill', type:'fill', source:'bldg',
        paint:{ 'fill-color':'#111827', 'fill-opacity':0.9 } });
      if (!map.getLayer('bldg-line')) map.addLayer({ id:'bldg-line', type:'line', source:'bldg',
        paint:{ 'line-color':'#ffffff', 'line-width':0.2, 'line-opacity':0.5 } });

      // UHI
      addGeoJSONSource(map, 'uhi', Layers.uhi.dataVar);
      if (!map.getLayer('uhi-fill')) map.addLayer({ id:'uhi-fill', type:'fill', source:'uhi',
        paint:{ 'fill-color': [
          'interpolate', ['linear'],
          ['coalesce', ['to-number', ['get','value']], 0],
          0, '#fee5d9', 1, '#fcae91', 2, '#fb6a4a', 3, '#de2d26', 4, '#a50f15'
        ], 'fill-opacity':0.65 } });
      if (!map.getLayer('uhi-line')) map.addLayer({ id:'uhi-line', type:'line', source:'uhi',
        paint:{ 'line-color':'#a8a29e', 'line-width':0.3, 'line-opacity':0.7 } });

      // Vegetation (trees)
      addGeoJSONSource(map, 'veg', Layers.vegetation.dataVar);
      if (!map.getLayer('veg-point')) map.addLayer({ id:'veg-point', type:'circle', source:'veg',
        paint:{ 'circle-radius':3, 'circle-color':'#16a34a', 'circle-stroke-width':0.6, 'circle-stroke-color':'#064e3b' } });

      // Roads
      addGeoJSONSource(map, 'roads', Layers.roads.dataVar);
      if (!map.getLayer('road-line')) map.addLayer({ id:'road-line', type:'line', source:'roads',
        paint:{ 'line-color': [
          'match', ['get','ro_typo'],
          'primary', '#111827',
          'secondary', '#4b5563',
          'tertiary', '#9ca3af',
          'pedestrian', '#6b7280',
          /* other */ '#9ca3af'
        ], 'line-width': ['interpolate',['linear'],['coalesce',['to-number',['get','ro_width']],2.0], 2, 0.6, 30, 3.0], 'line-opacity':0.85 } });

      // Contours
      addGeoJSONSource(map, 'contours', Layers.contours.dataVar);
      if (!map.getLayer('contour-line')) map.addLayer({ id:'contour-line', type:'line', source:'contours',
        paint:{ 'line-color':'#64748b', 'line-width': 1.0, 'line-opacity':0.55 } }, 'bldg-line');
    }

    const presets = {
      uhi:       { show: ['uhi-fill','uhi-line'], dim: ['bldg-fill','bldg-line'], extras: ['road-line','contour-line','site-line','plot-fill','plot-line','veg-point'] },
      vegetation:{ show: ['veg-point'], dim: ['bldg-fill','bldg-line'], extras: ['road-line','contour-line','site-line','plot-fill','plot-line','uhi-fill','uhi-line'] },
      buildings: { show: ['bldg-fill','bldg-line'], dim: [], extras: ['road-line','contour-line','site-line','plot-fill','plot-line','uhi-fill','uhi-line','veg-point'] },
      contours:  { show: ['contour-line'], dim: ['bldg-fill','bldg-line'], extras: ['road-line','site-line','plot-fill','plot-line','uhi-fill','uhi-line','veg-point'] },
      roads:     { show: ['road-line'], dim: ['bldg-fill','bldg-line'], extras: ['contour-line','site-line','plot-fill','plot-line','uhi-fill','uhi-line','veg-point'] },
      site:      { show: ['site-line','plot-fill','plot-line'], dim: ['bldg-fill','bldg-line'], extras: ['road-line','contour-line','uhi-fill','uhi-line','veg-point'] }
    };

    function applyPreset(map, key) {
      const all = new Set([].concat(...Object.values(presets).map(v=>[...v.show, ...v.dim, ...v.extras])));
      all.forEach(id => { if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'none'); });
      (presets[key]?.show || []).forEach(id => { if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'visible'); });
      (presets[key]?.dim || []).forEach(id => {
        if (id==='bldg-fill' && map.getLayer(id)) {
          map.setLayoutProperty(id, 'visibility', 'visible');
          map.setPaintProperty(id, 'fill-color', '#111827');
          map.setPaintProperty(id, 'fill-opacity', 0.35);
        }
      });
      (presets[key]?.extras || []).forEach(id => { if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'visible'); });
    }

    function attachFeatureInfo(map) {
      Object.keys(Layers).forEach(key=>{
        const L = Layers[key];
        L.layerIds.forEach(id=>{
          if (!map.getLayer(id)) return;
          map.on('click', id, (e)=>{
            const f = e.features?.[0];
            if (!f) return;
            const fields = Layers[key].fields;
            const rows = Object.keys(fields).map(k=> `<div><span class="lab">${fields[k].label||k}:</span> ${f.properties[k]??'—'}</div>`).join('');
            const html = `<div class="tip"><div class="tip-title">${Layers[key].title}</div>${rows}</div>`;
            new mapboxgl.Popup({ closeButton:true, closeOnClick:true })
              .setLngLat(e.lngLat).setHTML(html).addTo(map);
          });
          map.on('mouseenter', id, ()=> map.getCanvas().style.cursor='pointer');
          map.on('mouseleave', id, ()=> map.getCanvas().style.cursor='');
        });
      });
    }

    map.on('load', ()=>{
      // Fit to site boundary if available
      try {
        const siteGeom = window.json_majas_tekdi_2?.features?.[0]?.geometry || null;
        if (siteGeom && window.turf) {
          const b = turf.bbox({ type:'Feature', geometry: siteGeom, properties:{} });
          map.fitBounds([[b[0], b[1]],[b[2], b[3]]], { padding: 40, duration: 0 });
        }
      } catch(e) {}

      addLayers(map);
      applyPreset(map, Store.state.activeLayer);
      attachFeatureInfo(map);
      renderLayerSection(Store.state);
      updateAttributesPanel(Store.state);
      renderKPIs(Store.state);
    });

    // React to UI changes
    Store.on(s=>{
      if (window.map && map.loaded()) applyPreset(map, s.activeLayer);
    });

    // Mount UI
    document.addEventListener('DOMContentLoaded', mountSidebar);
  </script>
</body>
</html>
